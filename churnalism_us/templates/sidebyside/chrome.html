{% extends "base.html" %}

{% load jsonify %}
{% load trailingslash %}
{% block title %}Churnalism - Side by Side View {% endblock %}

{% comment %}
This template stands alone because the chrome extension performs a POST request
and then dynamically injects the result into a source-less iframe. This causes
relative links inside the injected iframe to be relative to the containing page,
so all links output must be absolute.
{% endcomment %}

    {% block head %}
        <style type="text/css">
            iframe, html, body { padding: 0; margin: 0; }
            ul { margin: 0; padding-top: 0; padding-bottom: 0; }
			body {
				background-color: #fbf8f3; 
				font-family: Georgia,Times New Roman,Times,serif;
			}
			#explain-bar {
				background: none #f9f6ed;
				border-bottom: 1px solid #363671;
				font-family: Helvetica,Arial,sans-serif;
				padding: 1em;
			}
			#explain {
				margin: 0 0 1em 0;
				width: 85%;
			}
			#sidebysideHeader { 
			    margin-top: 15px;
			    margin-bottom: 40px;
			}
			#match-bar {
				font-family: Helvetica,Arial,sans-serif;
				font-size: 2.8em;
				font-weight: bold;
				float: right;
			}
			#sidebysideHeader a { float: left; font-size: 110%; margin-top: 13px; }
			span#overlap-label {
				position: relative;
				float: right;
				line-height: 30px;
			}
			.link-separator {
				letter-spacing: 117%;
				font-weight: bold;
			}
			h1 {
				font-size: 120%;
			}
			#sidebyside-title-box {
				width: 100%;
				max-height: 25%;
			}
            #sidebyside-box {
                width: 100%;
			}
			#doc-title-box, #pr-title-box {
				-webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
				-moz-box-sizing: border-box;    /* Firefox, other Gecko */
				box-sizing: border-box;         /* Opera/IE 8+ */
				float: left;
				width: 46%;
				margin: 0;
				padding: 2%;
			}
			#pr-title, #doc-title { font-size: 1.8em; }
            #doc-box, #pr-box {
				-webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
				-moz-box-sizing: border-box;    /* Firefox, other Gecko */
				box-sizing: border-box;         /* Opera/IE 8+ */
                float: left;
                width: 46%;
                height: 100%;
                margin: 0;
                padding: 2%;
            }
            #doc-text, #pr-text {
			}
			.churnalism-highlight {
				background-color: #F6F93A;
				padding: 0;
				margin: 0;
				font-style: italic;
			}
			span.churnalism-highlight-pair {
				background-color: #E7CC29;
			}
			span.churnalism-highlight-selected {
				background-color: #805CCF;
				background-color: #E7CC29;
			}
			.clear {
				clear: both;
			}
	    #container { border-top: 1px solid #E5E1DD; } 
	    #share { display: none; }
		svg#fragment-connector {
			z-index: 0;
			padding: 0;
			margin: 0;
			border-width: 0;
		}
		#bezier {
			stroke-dasharray: 6 3;
			stroke: #E7CC29;
		}
        </style>
        <title>{% firstof source_title match_title "Search Results" %}</title>
    {% endblock %}

    {% block overlap %}
    <div id="sidebysideHeader">
        <a href="#">Â« Back to all Matches</a>
    	<div id="match-bar">
    	    <span id="overlap-label">Overlap: {{ match.coverage.1|floatformat:0 }}%</span>
    	</div>
    	<div class="clear"></div>
	</div>
    {% endblock %}

    {% block body %}
        <div style="position: relative;">
<!--			<div id="explain-bar">
				<div id="explain">It's possible that the document on the left was partially copied from the document on the right because they overlap {{ match.coverage.1|floatformat:0 }}%.</div>
				{% if match_count > 1 %}
				{{ match_count|add:-1 }} other documents also match. <a href="{{ ABSOLUTE_BASE_URL|trailingslash:0 }}{% url sidebyside-permalink uuid match.doctype match.docid %}" target="_blank">See those results</a>
				{% endif %}
			</div> -->
			
			<div id="sidebyside-title-box">
				<div id="doc-title-box">
					<h2 class="withTip" id="doc-title">
						{{ source_title }}
					</h2>
				</div>
				<div id="pr-title-box">
					<h2 class="withTip" id="pr-title">
						{{ match_title }}
					</h2>
                    <em>Source: {{match_source}}</em>
				</div>
				<div class="clear">
				</div>
			</div>
            <div id="sidebyside-box">
                <div id="doc-box">
                    <div id="doc-text">
                        {{ source_text }}
                    </div>
                </div>
                <div id="pr-box">
                    <div id="pr-text">
                        {{ match_text }}
                    </div>
                </div>
				<div class="clear">
				</div>
            </div>
			<div id="footer">
			</div>
        </div>
        {% endblock %}
{% block js %}
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script type="text/javascript" src="{{ ABSOLUTE_STATIC_URL }}scripts/highlight.js"></script>
		<script type="text/x-jquery-template" id="connector-tmpl">
			<svg id="fragment-connector" pointer-events="none">
				<line id="source-bar" stroke="#805CCF" stroke-width="3"/>
				<line id="source-cross" stroke-width="3" stroke="#805CCF"/>
				<line id="target-bar" stroke="#805CCF" stroke-width="3"/>
				<line id="target-cross" stroke-width="3" stroke="#805CCF"/>
				<line id="vertical-connector" stroke-width="3" stroke="#805CCF"/>
				<path id="bezier" stroke="#805CCF" stroke-width="3" fill="none"/>
				<g stroke="none" stroke-width="3" fill="none">
					<circle id="A" r="3" />
					<circle id="B" r="3" />
					<circle id="C" r="3" />
					<circle id="D" r="3" />
					<circle id="E" r="3" />
				</g>
			</svg>
		</script>
        <script type="text/javascript">
			var top_of = function (elem) {
				return elem.offset().top;
			};
			var bottom_of = function (elem) {
				return elem.offset().top + elem.outerHeight();
			};
			var middle_of = function (elem) {
				return top_of(elem) + ((bottom_of(elem) - top_of(elem)) / 2);
			};
			var right_of = function (elem) {
				return elem.offset().left + elem.outerWidth();
			};
			var left_of = function (elem) {
				return elem.offset().left;
			};
			var fragment_pair = function (frag_number) {
				return $("span.churnalism-highlight").filter(function(){
					var f = $(this).attr('churnalism:fragment');
					return ((f != null) && (f == frag_number));
				});
			};
			var snippet_for_fragment = function (text, fragment) {
				return text.slice(fragment[0], fragment[2]);
			};
			var draw_connector = function (source_elem, target_elem) {
				var higher_elem = (top_of(source_elem) <= top_of(target_elem)) ? source_elem : target_elem;
				var source_on_top = (source_elem == higher_elem);
				var lower_elem = source_on_top ? target_elem : source_elem;

				var conn_top = top_of(higher_elem);
				var conn_height = (top_of(lower_elem) - top_of(higher_elem)) + lower_elem.outerHeight();
				var conn_left = right_of(source_elem);
				var conn_width = left_of(target_elem) - conn_left;

				var svg = $($("#connector-tmpl").html());
				svg.css('position', 'absolute');
				svg.css('z-index', '999999');
				svg.css('top', conn_top + 'px');
				svg.css('height', conn_height + 'px');
				svg.css('width', conn_width + 8 + 'px');
				svg.css('left', right_of(source_elem) + 'px');
				svg.css('background-color', 'transparent');
				$("body").append(svg);

				$(window).resize(function(resize){
					var source_elem = $('#doc-text span.churnalism-highlight-selected');
					var target_elem = $('#pr-text span.churnalism-highlight-selected');
					var source_on_top = (top_of(source_elem) <= top_of(target_elem));
					var higher_elem = source_on_top ? source_elem : target_elem;
					var lower_elem = source_on_top ? target_elem : source_elem;
					svg.css('top', Math.min(top_of(source_elem), top_of(target_elem)));
					svg.css('left', right_of(source_elem));
					svg.css('z-index', '999999');
				});
				
				var localize_x = function (x) {
					return x - conn_left + 1;
				};
				var localize_y = function (y) {
					return y - conn_top;
				};

				// Define the points through which the bezier line will pass
				// Point A is always defined in terms of the source element while 
				// point E is always in terms of the target element. C is the mid-point.
				var STARTy = localize_y(source_on_top ? top_of(source_elem) : bottom_of(source_elem));
				var ENDy = localize_y(source_on_top ? bottom_of(target_elem) : top_of(target_elem));
				var Ax = localize_x(right_of(source_elem));
				var Ay = localize_y(source_on_top ? bottom_of(source_elem) : top_of(source_elem));
				var Ex = localize_x(left_of(target_elem));
				var Ey = localize_y(source_on_top ? top_of(target_elem) : bottom_of(target_elem));
				var Cx = Ax + ((Ex - Ax) / 2);
				var Cy = Ay + ((Ey - Ay) / 2);

				// B and D are control points. They are the mid-points of the boxes created by 
				// (A,C) and (C,E) so as to create shallow curves.
				var Bx = Ax;
				var By = Ay + ((Cy - Ay) / 2);
				var Dx = Ex;
				var Dy = Ey - ((Ey - Cy) / 2);

				$("#A", svg).attr('cx', Ax);
				$("#A", svg).attr('cy', Ay);
				$("#B", svg).attr('cx', Bx);
				$("#B", svg).attr('cy', By);
				$("#C", svg).attr('cx', Cx);
				$("#C", svg).attr('cy', Cy);
				$("#D", svg).attr('cx', Dx);
				$("#D", svg).attr('cy', Dy);
				$("#E", svg).attr('cx', Ex);
				$("#E", svg).attr('cy', Ey);

				var path_tmpl = 'MAx,STARTy LAx,Ay QBx,By Cx,Cy QDx,Dy Ex,Ey LEx,ENDy';
				var path = path_tmpl.replace(/Ax/g, Ax)
									.replace('Ay', Ay)
									.replace('Bx', Bx)
									.replace('By', By)
									.replace('Cx', Cx)
									.replace('Cy', Cy)
									.replace('Dx', Dx)
									.replace('Dy', Dy)
									.replace(/Ex/g, Ex)
									.replace('Ey', Ey)
									.replace('STARTy', STARTy)
									.replace('ENDy', ENDy);
				$("#bezier", svg).attr('d', path);
			};
            var search_results = {{ results|jsonify|safe }};
			var markupArticleText = function (txt) {
				var trimmed = txt.trim();
				var normalizedWhitespace = trimmed.replace(/^\s+$/gm, '');
				var hasConsecutiveLineBreaks = /[\r\n]{2,}/g.test(normalizedWhitespace);
				var lineBreakPatternText = '(\\r|\\n|\\r\\n|\\n\\r)';
				if (hasConsecutiveLineBreaks)
					lineBreakPatternText = lineBreakPatternText + '{2,}';
				var lineBreakPattern = new RegExp(lineBreakPatternText, "g");
				var withPTags = normalizedWhitespace.replace(lineBreakPattern, '</p><p>');
				return '<p>' + withPTags + '</p>';
			};

            $(document).ready(function(){
                var doc_text_el = document.getElementById('doc-text');
				var match_text_el = document.getElementById('pr-text');
				$(doc_text_el).html($(doc_text_el).text());
				$(match_text_el).html($(match_text_el).text());
                $.each(search_results['documents']['rows'], function(idx, row){
					$.each(row['snippets'], function(snippet_idx, snippet){
						var sub_snippets = snippet.split(/[\r\n]+/).map(function(ss){ return ss.trim(); });
						$.each(sub_snippets, function(subsnippet_idx, sub_snippet){
							if (sub_snippet.length > 0) {
								highlight_match(match_text_el, sub_snippet, snippet_idx);
								highlight_match(doc_text_el, sub_snippet, snippet_idx);
							}
						});
					});
				});
				$(doc_text_el).html(markupArticleText($(doc_text_el).html()));
				$(match_text_el).html(markupArticleText($(match_text_el).html()));

				$('.churnalism-highlight').hover(function(){
					var frag_number = $(this).attr('churnalism:fragment');
					var fragments = fragment_pair(frag_number);
					fragments.addClass('churnalism-highlight-pair');
				});
				$('.churnalism-highlight').mouseout(function(){
					var frag_number = $(this).attr('churnalism:fragment');
					var fragments = fragment_pair(frag_number);
					fragments.removeClass('churnalism-highlight-pair');
				});
				$('.churnalism-highlight').click(function(click){
					var frag_number = $(this).attr('churnalism:fragment');
					var fragments = fragment_pair(frag_number);
					var was_selected = $(this).hasClass('churnalism-highlight-selected');
					$('.churnalism-highlight').removeClass('churnalism-highlight-selected');
					$("#fragment-connector").remove();
					if (! was_selected) {
						fragments.addClass('churnalism-highlight-selected');
						draw_connector(jQuery(fragments[0]), jQuery(fragments[1]));
					}
				});
			});

        </script>
{% endblock %}        

